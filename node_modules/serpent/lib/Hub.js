
var fs = require("fs");
var path = require("path");

global.__root = path.join(__dirname, "../");
global.__lib = path.join(__root, "lib/");

var hub = new (require("events").EventEmitter);
var engine = require("engine.io");
var server = require("http").createServer(function (req, res) {
	hub.emit("http_request", req, res);
});
var io = engine.attach(server);

io.on("connection", function (socket) {
	console.log("client connected");
	socket.on("message", function (packet) {
		try {
			packet = JSON.parse(packet);
			console.log("packet", packet);
		}
		catch (err) {
			log.error("packet parse", err);
		}
	});
	socket.on("close", function () {
		console.log("client disconnected");
	});
	var client = {};
	client.sendPacket = function (packet) {
		socket.write(JSON.stringify(packet));
	};
	client.sendPacket({oc: "sys_msg", msg: "welcome!!"});
});

hub.on("http_request", function (req, res) {
	if (req.url === "/js/engine.io.js") {
		res.setHeader("Content-type", "application/javascript");
		res.writeHead(200);
		fs.createReadStream(path.join(__root, "node_modules/engine.io-client/engine.io.js")).pipe(res);
	}
	else if (req.url === "/js/jquery.js") {
		res.setHeader("Content-type", "application/javascript");
		res.writeHead(200);
		fs.createReadStream(path.join(__root, "templates/jquery-1.11.2.min.js")).pipe(res);
	}
	else if (req.url === "/js/client.js") {
		res.setHeader("Content-type", "application/javascript");
		res.writeHead(200);
		fs.createReadStream(path.join(__root, "templates/client.js")).pipe(res);
	}
	else {
		res.setHeader("Content-type", "text/html");
		res.writeHead(200);
		fs.createReadStream(path.join(__root, "templates/login.html")).pipe(res);
	}
});

server.listen(8338, "robert-pc", function () {
	hub.emit("server_online");
	console.log("Server listening on robert-pc:8338");
});
